# -----------------------------------------------------------------------------#
#                                                                              #
#                Sample proxied API server app for testing.                    #
#                                                                              #
# -----------------------------------------------------------------------------#

# The sample backend API server app we are protecting with OpenID Connect.
upstream my_backend_api {
    zone my_backend_api 64k;
    server 127.0.0.1:9090;
}

# The sample API endpoints as we don't have the real upstream server.
server {
    error_log   /var/log/nginx/error.log    debug;  # Reduce severity level as required.
    access_log  /var/log/nginx/access.log   main;   # Enable when you want to debug access log.

    listen          9090;
    server_name     localhost;

    # For testing one of API endpoints without access token.
    location /v1/api/1 {
        default_type application/json;
        return 200 
        '{"code": "1", "message": "tested /v1/api/1 without access token."}\n';
    }

    # For testing one of API endpoints w/ bearer access token in the header.
    location /v1/api/2 {
        default_type application/json;
        js_content oidc.testExtractBearerToken;
    }

    # For testing validation of access token in the bearer token of the header.
    # https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowTokenValidation
    location = /_access_token_validation {
        internal;
        auth_jwt "" token=$arg_token;
        js_content oidc.validateAccessToken;
        error_page 500 502 504 @oidc_error;
    }

    # For testing API request failure.
    set $internal_error_message "API failure\n";
    location @api_error {
        status_zone "API error";
        default_type text/plain;
        return 500 $internal_error_message;
    }
}
